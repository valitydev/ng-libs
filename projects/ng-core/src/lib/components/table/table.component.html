<div class="table">
    <v-input-field
        *ngIf="!noFilter && (standaloneFilter || noActions)"
        [formControl]="filterControl"
        class="v-table-filter-standalone"
        label="Filter"
    ></v-input-field>
    <v-actions *ngIf="!noActions">
        <v-actions>
            <div *ngIf="update.observed">
                <button
                    [disabled]="!!progress"
                    mat-icon-button
                    matTooltip="Reload {{ size }} elements"
                    style="margin: -6px 0"
                    (click)="load()"
                >
                    <mat-icon>refresh</mat-icon>
                </button>
                <button
                    [color]="isPreload && hasMore ? 'accent' : undefined"
                    [disabled]="!!progress || !hasMore"
                    mat-icon-button
                    matTooltip="Preload {{ preloadSize }}{{
                        isPreload && hasMore ? ' more' : ''
                    }} elements"
                    style="margin: -6px 0"
                    (click)="preload()"
                >
                    <mat-icon>{{
                        hasMore || progress
                            ? isPreload && hasMore
                                ? 'downloading'
                                : 'download'
                            : 'download_done'
                    }}</mat-icon>
                </button>
            </div>
            <v-input-field
                *ngIf="!noFilter && !standaloneFilter"
                [formControl]="filterControl"
                appearance="outline"
                class="v-table-filter"
                label="Filter"
            ></v-input-field>
        </v-actions>
        <div>
            <ng-content select="v-table-actions"></ng-content>
        </div>
    </v-actions>
    <div class="table-card-details">
        <div class="details">
            <div>
                Quantity:
                {{
                    progress
                        ? '...'
                        : data?.length
                        ? data.length + (hasMore ? ' (more available)' : ' (all)')
                        : '0'
                }}<ng-container *ngIf="filterControl.value && !filterChange.observed">
                    | Filtered:
                    {{
                        (filterProgress$ | async) ? '...' : filteredDataLength ?? '0'
                    }}</ng-container
                ><ng-container *ngIf="selection.selected?.length">
                    | <b>Selected: {{ selection.selected.length }}</b></ng-container
                >
            </div>
        </div>
        <mat-card class="table-card">
            <mat-progress-bar
                *ngIf="progress || (filterProgress$ | async)"
                class="progress-bar"
                mode="indeterminate"
            ></mat-progress-bar>
            <table
                [dataSource]="dataSource"
                [matSortActive]="sort.active"
                [matSortDirection]="sort.direction"
                mat-table
                matSort
                (matSortChange)="sortChanged($event)"
            >
                <ng-container [matColumnDef]="scoreColumnDef">
                    <th
                        *matHeaderCellDef
                        [mat-sort-header]="scoreColumnDef"
                        mat-header-cell
                        style="display: none"
                    >
                        Score
                    </th>
                    <td *matCellDef="let row; let index = index" mat-cell style="display: none">
                        {{ scores.get(row)?.score | number: '1.2-2' : 'en' }}
                    </td>
                </ng-container>
                <ng-container *ngIf="rowSelectable" [matColumnDef]="selectColumnDef" sticky>
                    <th *matHeaderCellDef class="pinned-left" mat-header-cell>
                        <mat-checkbox
                            [checked]="selection.hasValue() && isAllSelected()"
                            [disabled]="!!progress || (!!filterControl.value && !isAllSelected())"
                            [indeterminate]="selection.hasValue() && !isAllSelected()"
                            (change)="$event ? toggleAllRows() : null"
                        >
                        </mat-checkbox>
                    </th>
                    <td *matCellDef="let row" class="pinned-left" mat-cell>
                        <mat-checkbox
                            [checked]="selection.isSelected(row)"
                            [disabled]="!!progress"
                            (change)="$event ? selection.toggle(row) : null"
                            (click)="$event.stopPropagation()"
                        >
                        </mat-checkbox>
                    </td>
                </ng-container>

                <ng-container
                    *ngFor="let col of columnsObjects.values()"
                    [matColumnDef]="col.field"
                    [sticky]="col.pinned === 'left'"
                    [stickyEnd]="col.pinned === 'right'"
                >
                    <ng-container *ngIf="col.sortable; else noSort">
                        <th
                            *matHeaderCellDef
                            [mat-sort-header]="col.field"
                            [ngClass]="{
                                'pinned-left': col.pinned === 'left',
                                'pinned-right': col.pinned === 'right'
                            }"
                            [ngStyle]="{
                                width: col.width,
                                'min-width': col.minWidth,
                                'max-width': col.maxWidth
                            }"
                            mat-header-cell
                        >
                            {{ col.header }}
                        </th>
                    </ng-container>
                    <ng-template #noSort>
                        <th
                            *matHeaderCellDef
                            [ngClass]="{
                                'pinned-left': col.pinned === 'left',
                                'pinned-right': col.pinned === 'right'
                            }"
                            [ngStyle]="{
                                width: col.width,
                                'min-width': col.minWidth,
                                'max-width': col.maxWidth
                            }"
                            mat-header-cell
                        >
                            {{ col.header }}
                        </th>
                    </ng-template>
                    <td
                        *matCellDef="let row; let index = index"
                        [ngClass]="{
                            'pinned-left': col.pinned === 'left',
                            'pinned-right': col.pinned === 'right'
                        }"
                        [ngStyle]="{
                            width: col.width,
                            'min-width': col.minWidth,
                            'max-width': col.maxWidth
                        }"
                        mat-cell
                    >
                        <v-table-cell
                            *ngIf="!col.cellTemplate && !cellTemplate[col.field]; else cellTpl"
                            [colDef]="col"
                            [index]="index"
                            [preloadLazy]="
                                index < preloadedLazyRowsCount || !!preloadedLazyCells.get(row)
                            "
                            [rowData]="row"
                            (preloadedLazyChange)="preloadedLazyCells.set(row, $event)"
                        ></v-table-cell>
                        <ng-template
                            #cellTpl
                            [ngTemplateOutlet]="$any(col.cellTemplate ?? cellTemplate[col.field])"
                            [ngTemplateOutletContext]="{
                                $implicit: row,
                                colDef: col,
                                index: index,
                                rowData: row
                            }"
                        ></ng-template>
                    </td>
                </ng-container>

                <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>
                <tr *matRowDef="let row; columns: displayedColumns" mat-row></tr>

                <ng-container [matColumnDef]="noRecordsColumnDef">
                    <td
                        *matFooterCellDef
                        [colSpan]="displayedColumns.length"
                        class="no-records mat-body-1"
                        mat-footer-cell
                    >
                        {{ data.length ? 'No records found' : 'No records' }}
                    </td>
                </ng-container>

                <tr
                    *matFooterRowDef="isNoRecords ? [noRecordsColumnDef] : []"
                    [style.display]="isNoRecords ? 'table-row' : 'none'"
                    mat-footer-row
                ></tr>
            </table>
        </mat-card>
    </div>
    <v-show-more-button
        *ngIf="hasShowMore"
        [disabled]="!!progress"
        [displayedPages]="displayedPages"
        [length]="data?.length ?? 0"
        [pageSize]="size"
        [progress]="!!progress"
        (more)="showMore()"
    ></v-show-more-button>
</div>
