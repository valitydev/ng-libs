<div class="table">
    <v-actions *ngIf="!noActions">
        <v-actions>
            <ng-container *ngIf="update.observed">
                <button
                    [disabled]="!!progress"
                    mat-stroked-button
                    matTooltip="Reload {{ size }} elements"
                    (click)="load()"
                >
                    Update
                </button>
                <button
                    *ngIf="rowSelectable"
                    [disabled]="!!progress || !hasMore"
                    mat-button
                    matTooltip="Preload {{ preloadSize }}{{
                        isPreload && hasMore ? ' more' : ''
                    }} elements"
                    (click)="preload()"
                >
                    {{ isPreload ? (hasMore ? 'Preload more' : 'Preloaded') : 'Preload' }}
                </button>
            </ng-container>
        </v-actions>
        <div>
            <ng-content select="v-table-actions"></ng-content>
        </div>
    </v-actions>
    <div class="table-card-details">
        <div class="details">
            <div>
                Quantity:
                {{
                    progress
                        ? '...'
                        : data?.length
                        ? data.length + (hasMore ? ' (more available)' : ' (all)')
                        : '0'
                }}<ng-container *ngIf="selection.selected?.length">
                    | <b>Selected: {{ selection.selected.length }}</b></ng-container
                >
            </div>
        </div>
        <mat-card class="table-card">
            <mat-progress-bar
                *ngIf="progress"
                class="progress-bar"
                mode="indeterminate"
            ></mat-progress-bar>
            <table
                [dataSource]="dataSource"
                [matSortActive]="sortActive ?? ''"
                [matSortDirection]="sortDirection ?? ''"
                mat-table
                matSort
                (matSortChange)="sortChanged($event)"
            >
                <ng-container *ngIf="rowSelectable" [matColumnDef]="selectColField" sticky>
                    <th *matHeaderCellDef class="pinned-left" mat-header-cell>
                        <mat-checkbox
                            [checked]="selection.hasValue() && isAllSelected()"
                            [disabled]="!!progress"
                            [indeterminate]="selection.hasValue() && !isAllSelected()"
                            (change)="$event ? toggleAllRows() : null"
                        >
                        </mat-checkbox>
                    </th>
                    <td *matCellDef="let row" class="pinned-left" mat-cell>
                        <mat-checkbox
                            [checked]="selection.isSelected(row)"
                            [disabled]="!!progress"
                            (change)="$event ? selection.toggle(row) : null"
                            (click)="$event.stopPropagation()"
                        >
                        </mat-checkbox>
                    </td>
                </ng-container>

                <ng-container
                    *ngFor="let col of columnsObjects.values()"
                    [matColumnDef]="col.field"
                    [sticky]="col.pinned === 'left'"
                    [stickyEnd]="col.pinned === 'right'"
                >
                    <ng-container *ngIf="col.sortable; else noSort">
                        <th
                            *matHeaderCellDef
                            [mat-sort-header]="col.field"
                            [ngClass]="{
                                'pinned-left': col.pinned === 'left',
                                'pinned-right': col.pinned === 'right'
                            }"
                            [ngStyle]="{
                                width: col.width,
                                'min-width': col.minWidth,
                                'max-width': col.maxWidth
                            }"
                            mat-header-cell
                        >
                            {{ col.header }}
                        </th>
                    </ng-container>
                    <ng-template #noSort>
                        <th
                            *matHeaderCellDef
                            [ngClass]="{
                                'pinned-left': col.pinned === 'left',
                                'pinned-right': col.pinned === 'right'
                            }"
                            [ngStyle]="{
                                width: col.width,
                                'min-width': col.minWidth,
                                'max-width': col.maxWidth
                            }"
                            mat-header-cell
                        >
                            {{ col.header }}
                        </th>
                    </ng-template>
                    <td
                        *matCellDef="let row; let index = index"
                        [ngClass]="{
                            'pinned-left': col.pinned === 'left',
                            'pinned-right': col.pinned === 'right'
                        }"
                        [ngStyle]="{
                            width: col.width,
                            'min-width': col.minWidth,
                            'max-width': col.maxWidth
                        }"
                        mat-cell
                    >
                        <v-table-cell
                            *ngIf="!col.cellTemplate && !cellTemplate[col.field]; else cellTpl"
                            [colDef]="col"
                            [index]="index"
                            [rowData]="row"
                        ></v-table-cell>
                        <ng-template
                            #cellTpl
                            [ngTemplateOutlet]="$any(col.cellTemplate ?? cellTemplate[col.field])"
                            [ngTemplateOutletContext]="{
                                $implicit: row,
                                colDef: col,
                                index: index,
                                rowData: row
                            }"
                        ></ng-template>
                    </td>
                </ng-container>

                <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>
                <tr *matRowDef="let row; columns: displayedColumns" mat-row></tr>

                <ng-container matColumnDef="__noRecords">
                    <td
                        *matFooterCellDef
                        [colSpan]="displayedColumns.length"
                        class="no-records mat-body-1"
                        mat-footer-cell
                    >
                        No records
                    </td>
                </ng-container>

                <tr
                    *matFooterRowDef="!progress && data && !data.length ? ['__noRecords'] : []"
                    [style.display]="!progress && data && !data.length ? 'table-row' : 'none'"
                    mat-footer-row
                ></tr>
            </table>
        </mat-card>
    </div>
    <v-show-more-button
        *ngIf="hasShowMore"
        [disabled]="!!progress"
        [displayedPages]="displayedPages"
        [length]="data?.length ?? 0"
        [pageSize]="size"
        [progress]="!!progress"
        (more)="showMore()"
    ></v-show-more-button>
</div>
