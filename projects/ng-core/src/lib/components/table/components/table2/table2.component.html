<div class="wrapper">
    <div style="flex: 0; white-space: nowrap; padding-top: 12px">
        <button
            [disabled]="progress()"
            mat-icon-button
            matTooltip="Reload {{ size() }} elements"
            style="margin: -6px 0"
            (click)="load()"
        >
            <mat-icon>refresh</mat-icon>
        </button>
        <button
            [color]="isPreload() && hasMore() ? 'accent' : undefined"
            [disabled]="progress() || !hasMore()"
            mat-icon-button
            matTooltip="Preload {{ preloadSize() }}{{
                isPreload() && hasMore() ? ' more' : ''
            }} elements"
            style="margin: -6px 0"
            (click)="preload()"
        >
            <mat-icon>{{
                hasMore() || progress()
                    ? isPreload() && hasMore()
                        ? 'downloading'
                        : 'download_for_offline'
                    : 'download_done'
            }}</mat-icon>
        </button>
        <button
            [disabled]="progress()"
            mat-icon-button
            matTooltip="Download CSV"
            style="margin: -6px 0"
            (click)="downloadCsv()"
        >
            <mat-icon>file_save</mat-icon>
        </button>
    </div>

    <v-table-info-bar
        [count]="count()"
        [hasMore]="hasMore()"
        [progress]="progress()"
    ></v-table-info-bar>

    <mat-card class="card">
        <v-table-progress-bar [progress]="progress()"></v-table-progress-bar>
        <div
            [vInfinityScroll]="infinityScroll()"
            [vInfinityScrollSkip]="progress()"
            class="scrolled-table-wrapper"
            (vInfinityScrollMore)="showMore()"
        >
            <table
                [dataSource]="dataSource"
                [ngClass]="{ 'table__loading-content-footer': hasLoadingContentFooter() }"
                mat-table
            >
                @for (col of normColumns(); track col; let colIndex = $index) {
                    <ng-container [matColumnDef]="col.field">
                        <th *matHeaderCellDef mat-header-cell>
                            <v-value [value]="col.header | async" inline></v-value>
                        </th>
                        <td
                            *matCellDef="let row; let rowIndex = index"
                            [ngStyle]="col?.params?.style"
                            mat-cell
                        >
                            @if (
                                (columnsData$$ | async)?.[rowIndex]?.[colIndex] | async;
                                as cellData
                            ) {
                                @if (cellData.length > 1) {
                                    <div class="multi-cell">
                                        @for (item of cellData; track item) {
                                            <v-value [value]="item" inline></v-value>
                                        }
                                    </div>
                                } @else {
                                    <v-value [value]="cellData[0]" inline></v-value>
                                }
                            } @else {
                                <v-value [progress]="true" inline></v-value>
                            }
                        </td>
                        <td *matFooterCellDef mat-footer-cell>
                            <v-value [progress]="true" inline></v-value>
                        </td>
                    </ng-container>
                }

                <v-no-records-column
                    [name]="columnDefs.noRecords"
                    [progress]="progress()"
                ></v-no-records-column>

                <tr *matHeaderRowDef="rowDefs(); sticky: true" mat-header-row></tr>
                <tr *matRowDef="let row; columns: rowDefs()" mat-row></tr>
                <tr
                    *matFooterRowDef="hasLoadingContentFooter() ? rowDefs() : []"
                    [style.display]="hasLoadingContentFooter() ? '' : 'none'"
                    mat-row
                ></tr>
                <tr
                    *matFooterRowDef="count() ? [] : [columnDefs.noRecords]"
                    [style.display]="count() ? 'none' : ''"
                    mat-footer-row
                ></tr>
            </table>
        </div>
    </mat-card>

    @if (!hasLoadingContentFooter() && (hasMore() || dataSource.paginator.length < count())) {
        <v-show-more-button
            [displayedPages]="dataSource.paginator.displayedPages"
            [length]="count()"
            [pageSize]="size()"
            [progress]="progress()"
            class="show-more-button"
            (more)="showMore()"
        ></v-show-more-button>
    }
</div>
