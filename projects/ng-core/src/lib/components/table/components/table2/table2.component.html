<div class="wrapper">
    <v-table-info-bar
        [count]="count()"
        [hasMore]="hasMore()"
        [progress]="progress()"
    ></v-table-info-bar>

    <mat-card class="table-card">
        <v-table-progress-bar [progress]="progress()"></v-table-progress-bar>
        <table #table [dataSource]="dataSource" mat-table>
            @for (col of normalizedColumns(); track col; let colIndex = $index) {
                <ng-container [matColumnDef]="col.field">
                    <th *matHeaderCellDef mat-header-cell>
                        <v-value [value]="col.header | async"></v-value>
                    </th>
                    <td *matCellDef="let row; let rowIndex = index" mat-cell>
                        @if ((columnsData$$ | async)?.[colIndex]?.[rowIndex] | async; as cellData) {
                            @if (cellData.length > 1) {
                                <table>
                                    @for (item of cellData; track item) {
                                        <tr>
                                            <td><v-value [value]="item"></v-value></td>
                                        </tr>
                                    }
                                </table>
                            } @else {
                                <v-value [value]="cellData[0]"></v-value>
                            }
                        }
                    </td>
                </ng-container>
            }
            <v-no-records-column
                [name]="columnDefs.noRecords"
                [progress]="progress()"
            ></v-no-records-column>

            <tr *matHeaderRowDef="rowDefs()" mat-header-row></tr>
            <tr *matRowDef="let row; columns: rowDefs()" mat-row></tr>
            <tr
                *matFooterRowDef="footerRowDefs()"
                [style.display]="footerRowDefs().length ? '' : 'none'"
                mat-footer-row
            ></tr>
        </table>
    </mat-card>

    @if (hasMore() || dataSource.paginator.length < count()) {
        <v-show-more-button
            [displayedPages]="dataSource.paginator.displayedPages"
            [length]="count()"
            [pageSize]="size()"
            [progress]="progress()"
            (more)="showMore()"
        ></v-show-more-button>
    }
</div>
